---
title: 유리 등차수열의 내림 합 (floor_sum) 빠르게 구하기
date: 9999-09-15 18:38:00 +0900
categories: [PS, Algorithm, 수학]
tags: []     # TAG names should always be lowercase
toc: true
comments: true
math: true
---

$$ \sum_{i=1}^{b} \left\lfloor \frac{pi+r}{q} \right\rfloor $$

의 값을 빠르게 구해 보자. 

기하학적으로 보았을 때, 이는 좌표평면에서 $0 < x \leq b$, $0 < y \leq \frac{px+r}{q}$인 격자점 $(x, y)$의 개수를 구하는 것과 같다. 다음은 $y = \frac{8x+3}{6}$를 격자점에 나타낸 것이다.

<img alt="" src="/assets/img/floor_sum/img1.png" style="max-width: 400px;">

따라서 $$\sum_{i=1}^{b} \left\lfloor \frac{8i+3}{6} \right\rfloor$$의 값은 그림에서 직선 아래에 있는 격자점의 개수와 같다. 

이때 $p \geq q$라면, $\newcommand\floor[2][]{\left\lfloor{#2}\right\rfloor} \floor{p/q} > 0$이다. 이 값을 $k$라고 하면, 정수 $p'$에 대해 $p = p' + kq$가 성립한다. 따라서

$$ \begin{aligned} \sum_{i=1}^b \floor{\frac{pi+r}{q}} & = \sum_{i=1}^b \floor{\frac{p'i+kqi+r}{q}} \\
& = \sum_{i=1}^b \floor{\frac{p'i+r}{q}+ki} \\
& = \sum_{i=1}^b \left(\floor{\frac{p'i+r}{q}} + ki \right) \\
& = \sum_{i=1}^b \floor{\frac{p'i+r}{q}} + \sum_{i=1}^b ki\\
& = \sum_{i=1}^b \floor{\frac{p'i+r}{q}} + \frac{kb(b+1)}{2}
\end{aligned} $$

가 된다. 따라서 정수의 나눗셈 정리에 따라 항상 $p' < q$가 되도록 하는 $p'$를 잡을 수 있다. $kb(b+1)/2$는 ${\cal O}(1)$에 계산할 수 있기 떄문에, 앞의 항만 계산할 수 있다면 전체 합을 계산하기에 충분하다. 그림에서의 예시를 들면, 빨간색 선은 $y = x$, 하늘색 선은 $y = \frac{2x+3}{6}$이며 둘의 합이 기존의 주황색 선과 같다는 것을 알 수 있다. 

<img alt="" src="/assets/img/floor_sum/img2.png" style="max-width: 400px;">

위에서 정리한 식과 같이 우리는 $(p'x+r)/q$ 부분, 즉 그림에서의 파란색 선과 그 아래쪽 격자점의 개수만 셀 수 있으면 된다. 이때 아래에서 빨간색으로 표시된 부분을 보자.

<img alt="" src="/assets/img/floor_sum/img3.png" style="max-width: 400px;">

$y = x$에 대칭시키면 마치 원래의 $y = (px+r)/q$ 식의 꼴처럼 생겼다. 거기에다가, 