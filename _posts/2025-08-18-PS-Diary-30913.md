---
title: BOJ 30913 - 위수는 쿼리입니까? (1)
date: 2025-08-18 14:57:00 +0900
categories: [PS]
tags: []     # TAG names should always be lowercase
toc: false
comments: true
math: true
---

## <boj-problem id=30913 tier='r4' name='위수는 쿼리입니까?'></boj-problem>

| 시간 제한 | 메모리 제한 |
|:---------|:---------|
| 2 초     | 1024 MB  |

## 문제
<hr>

 $2$ 이상의 자연수 $N$과, $1$ 이상 $N-1$ 이하의 자연수 $a$에 대하여 $a^e\equiv 1\pmod{N}$을 만족시키는 가장 작은 $1$ 이상의 정수 $e$를 법 $N$에 대한 $a$의 위수(order)라고 하고, $\operatorname{ord}_N(a)$로 표기합니다. 만약 그러한 수 $e$가 존재하지 않는 경우 편의상 $\operatorname{ord}_N(a) = 0$으로 정의합니다.

자연수 $N$이 주어졌을 때, 다음과 같은 쿼리를 처리해봅시다.

- 1 $a$: $\operatorname{ord}_N(a)$를 출력합니다. ($1\leq a\leq N-1$)
- 2 $e$: $\operatorname{ord}_N(a) =e$를 만족시키는 $1$ 이상 $N-1$ 이하의 자연수 $a$를 아무거나 하나 출력합니다. 만약 그러한 수가 존재하지 않으면 0을 출력합니다. ($1\leq e\leq N-1$)
- 3 $e$: $\operatorname{ord}_N(a) =e$를 만족시키는 $1$ 이상 $N-1$ 이하의 자연수 $a$의 개수를 출력합니다. ($1\leq e\leq N-1$)
- 4 $e$: $\operatorname{ord}_N(a) =e$를 만족시키는 $1$ 이상 $N-1$ 이하의 자연수 $a$의 합을  $N$으로 나눈 나머지를 출력합니다. ($1\leq e\leq N-1$)

## 입력
<hr>
첫째 줄에 자연수 $N$이 주어집니다. ($2\leq N\leq 4\times 10^{18}$)

둘째 줄에 쿼리의 개수 $Q$가 주어집니다. ($1\leq Q\leq 10\, 000$)

다음 $Q$개의 줄에는 쿼리가 한 줄에 하나씩 주어집니다.

## 출력
<hr>
$Q$개의 줄에 각 쿼리의 결과를 출력합니다. $\newcommand{\Bbb}[1]{\mathbb{#1}} \newcommand{\ZnZ}[1][n]{\Bbb{Z}/#1\Bbb{Z}} \newcommand{\ord}{\operatorname{ord}}$

## 풀이 과정
<hr>
기본적으로 $(\ZnZ)^\times$(= [$\ZnZ$의 곱셈군](https://en.wikipedia.org/wiki/Multiplicative_group_of_integers_modulo_n))의 구조를 알아야 쉽게 접근할 수 있는 문제이다. 어려운 말을 쓰자면, $(\ZnZ)^\times$는 유한 아벨군(가환군)이므로 [유한 생성 아벨군의 기본 정리](https://en.wikipedia.org/wiki/Abelian_group#Classification)에 의해 순환군들로 분해되며, 중국인의 나머지 정리는 그 자세한 분해를 알려준다. (이 글에서 직접적으로 유한 생성 아벨군의 기본 정리를 사용하지는 않으며, 참고용으로만 인용했다.)

<big>Theorem 1. (곱셈군에서 중국인의 나머지 정리)</big> $n = p_1^{e_1}p_2^{e_2} \cdots p_r^{e_r}$로 소인수분해될 때

$$ (\ZnZ)^\times \cong \prod_{i=1}^r (\ZnZ[p_i^{e_i}])^\times $$ 

이다. 

<b>Proof.</b> 증명을 위해 map $f : (\ZnZ)^\times \rightarrow \prod_{i=1}^r (\ZnZ[p_i^{e_i}])^\times, x \mapsto (x \bmod p_1^{e_1}, \cdots, x \bmod p_r^{e_r})$가 isomorphism임을 보이자. 

먼저 $xy \bmod p^e = (x \bmod p^e)(y \bmod p^e) \bmod p^e$이므로 $f(xy) = f(x)f(y)$임을 정의로부터 쉽게 보일 수 있다. 따라서 $f$는 homomorphism이다.

다음으로 $q_i := \dfrac{n}{p_i^{e_i}} = \left(\displaystyle\prod_{j=1}^{i-1} p_j^{k_j}\right) \left(\displaystyle\prod_{j=i+1}^{r} p_j^{k_j}\right)$을 정의하자. 또 $q_i \bar q_i \equiv 1 \pmod {p_i^{e_i}}$를 만족하는 $\bar q_i$를 생각하자. 이때 $q_i$는 $p_i^{e_i}$와 서로소이므로 곱셈 역원이 항상 존재한다. 

이제 $f$의 역사상을 $f^{-1} : (x_1, x_2, \cdots, x_r) \mapsto \displaystyle\sum_{i=1}^{r} x_i q_i \bar q_i$로 정의하자. $\vert(\ZnZ)^\times\vert = \vert\prod_{i=1}^r (\ZnZ[p_i^{e_i}])^\times\vert = \phi(n)$이므로 $f$가 injective나 surjective 중 하나임을 보이면 충분하다.

$$ \begin{aligned} 
f(f^{-1}(x_1, x_2, \cdots, x_r)) & = f\bigg(\sum_{i=1}^r x_i q_i \bar q_i\bigg) \\
& = (x_1 q_1 \bar q_1 \bmod {p_1^{e_1}}, \cdots, x_r q_r \bar q_r \bmod {p_r^{e_r}}) \\ 
& = (x_1 \bmod {p_1^{e_1}}, \cdots, x_r \bmod {p_r^{e_r}})
\end{aligned} $$

가 성립함을 보일 수 있다. 이로써 $f$는 surjective이고 따라서 isomorphism임을 보였다. 

$\ZnZ[p^e]$ 역시 유한 아벨군이므로 순환군들로 분해된다. 잘 알려진 사실로, 
- $p > 2$ 또는 $e < 3$인 경우 $\ZnZ[p^e]$ 자체가 순환군이다(원시근을 가진다).
- $p = 2$, $e \geq 3$인 경우 $\ZnZ[2^e]$는 순환군이 아니며, $\ZnZ[2^e] \cong \ZnZ[2] \times \ZnZ[2^{e-2}]$이다.

이를 증명하기 위해 다음 정리가 필요하다.

<big> Theorem 2. (라그랑주 정리)</big> 소수 $p$와 $\ZnZ[p]$ 위의 0이 아닌 다항식 $f$에 대해 $f(x) \equiv 0$의 해의 개수는 최대 $\deg f$개이다.

<b>Proof.</b> 수학적 귀납법을 사용한다. $\deg f = 1$인 경우, $a_1 x + a_0 \equiv 0$의 해는 $-\bar a_1 a_0$으로 유일하다. $k < n$에 대해 $\deg f = k$이 성립한다 하자. $f$의 해가 존재하지 않는다면 $0 \leq n$이므로 가정이 성립한다. 그렇지 않다면, $f$의 어떤 해를 $\alpha$라고 두자. 다항식의 나눗셈을 통해 $f$를 $\alpha$로 나눈 나머지를 $r$이라고 하면, 

$$ f(x) = (x-\alpha)g(x) + r $$

이 성립한다. 이때 $x = \alpha$를 대입하면 $r = 0$이 되기에 $f(x) = (x-\alpha)g(x)$가 된다. 따라서 $f(x) \equiv 0 \Longleftrightarrow x-\alpha \equiv 0 \text{ or } g(x) \equiv 0$이고, $\deg g < n$이므로 $g(x) \equiv 0$의 해는 $n-1$개 이하이고, $f(x) \equiv 0$의 해는 $n$개 이하이다. 따라서 가정이 성립한다.

$p$가 소수가 아니라면 가정이 성립하지 않는 것에 주의하자. 예를 들어, $x^2 - 4 \equiv 0 \pmod{15}$는 해가 $x = 2, 7, 8, 13$으로 4개이다.

<big> Theorem 3. </big> 소수 $p$에 대해 $\ord_p x = d$를 만족하는 $x$의 개수를 $\psi(d)$라고 할 때, 

$$\psi(d) = \begin{cases} \phi(d) & \text{if } d \mid (p-1) \\ 0 & \text {if } d \nmid (p-1) \end{cases}$$

이다.

<i>Lemma 3.1. $\ord_n x = d$인 $x$에 대해, $\ord_n (x^l) = d/{\rm gcd}(d, l)$이다.<br>
Proof. $\small l/{\rm gcd}(d, l)$가 정수이므로 $\small (x^l)^{d/{\rm gcd}(d, l)} = x^{l \cdot d/{\rm gcd}(d, l)} = (x^d)^{(l/{\rm gcd}(d, l))} = 1 \Rightarrow \ord_n (x^l) \mid d/{\rm gcd}(d,l)$ <br>
$\small(x^l)^{\ord_n (x^l)} = x^{l \cdot \ord_n (x^l)} = 1$이므로 $\small d \mid l \cdot \ord_n (x^l)$. 양변을 $\small\gcd(d,l)$로 나누면 $\small d/{\rm gcd}(d,l) \mid l/{\rm gcd}(d,l) \cdot \ord_n(x^l)$이고, $\small d/{\rm gcd}(d, l), l/{\rm gcd}(d, l)$은 서로소이므로 $\small d/{\rm gcd}(d,l) \mid \ord_n (x^l)$.</i>

<i>Lemma 3.2. $x^k \equiv 1$, $x^l \equiv 1$이면 $x^{\gcd(k, l)} \equiv 1$이다. 따라서 $x^k \equiv 1$이라면 $(\ord_n x) \mid k$이다.<br>
Proof. $\small \exists s, t \in \mathbb{Z}$ s.t. $ks+tl = \gcd(k, l)$이므로 $\small (x^k)^s \cdot (x^l)^t = x^{ks+tl} = x^{\gcd(k, l)} \equiv 1$. <br><small>더 엄밀한 증명을 위해서는 $\small s, t$가 음수일 경우, $\small x^{-k} \equiv \bar x^k$, 를 보일 필요가 있지만, 여기서는 간단히 설명하고 넘어간다.</small></i>

<b>Proof.</b> 만약 $\ord_p x = d$인 $x$가 존재하지 않는다면, $\psi(d) = 0$이다. 그렇지 않다면, 임의의 $\ord_p x = d$인 $x$에 대해 $$S_n = \{x^0, x^1, \cdots, x^{d-1}\}$$을 생각하자. $S_n$의 모든 원소는 $x^d \equiv 1$을 만족하고 $\vert S_n \vert = d$이므로, 라그랑주 정리에 의해 $S_n$은 $x^d \equiv 1$의 해집합과 동일하다. 이제 $S_n$의 원소 중에 위수가 정확히 $d$인 것을 찾아야 한다. 이는 $0, \cdots, d-1$ 중에 $\gcd(d, l) = 1$인 $l$의 개수와 동일하고, 이는 $\phi(d)$와 같다. 따라서 위수가 $d$인 원소가 하나라도 존재한다면 $\psi(d) = \phi(d)$이다. 


페르마의 소정리에 의해 모든 $x \not\equiv 0$은 $x^{p-1} \equiv 1$을 만족한다. 따라서 $\ord_p x = d$라면 $d \mid (p-1)$이 성립한다. 결과적으로 $d \nmid (p-1)$이라면 $\psi(d) = 0$임을 알 수 있다. 또한 모든 $x \not\equiv 0$은 1 이상의 위수를 가지기에, 

$$ \sum_{d \mid (p-1)} \psi(d) = p-1 $$

을 만족한다는 것을 알 수 있다. 이때 뫼비우스 반전 공식을 이용하면 

$$ \sum_{d \mid (p-1)} \phi(d) = p-1 $$

역시 보일 수 있다. 이제 두 식을 서로 빼면, 

$$ \sum_{d \mid (p-1)} (\phi(d)-\psi(d)) = 0 $$

이 된다. 이때 $\phi(d) - \psi(d)$가 $0$ 또는 $\phi(d)$라는 걸 위에서 보였고, 우변이 $0$이 되므로 $\phi(d) - \psi(d)$는 항상 $0$이 된다. 따라서 $d \mid (p-1)$이라면 $\psi(d) = \phi(d)$가 된다. 


<big> Theorem 4. ($(\ZnZ[p^e])^{\times}$에서의 원시근의 존재성)</big> 소수 $p$와 양의 정수 $e$에 대해, $(\ZnZ[p^e])^\times$는,
- $p > 2$ 또는 $e < 3$이면 원시근을 가진다.
- $p = 2$, $e \geq 3$이면 원시근을 가지지 않으며, 대신 모든 원소를 $\pm 5^k$ 꼴로 나타낼 수 있다.

<b>Proof.</b> 
- $e = 1$의 경우<br>
원시근의 위수는 $p-1$이고, Theorem 3에 의해 $\psi(p-1) = \phi(p-1) \neq 0$이므로 $\ZnZ[p]$는 항상 원시근을 가진다는 것을 알 수 있다.

- $p > 2, e \geq 2$의 경우<br>
$(1+sp)^{p^{e-1}} = \sum_{i=0}^{p^{e-1}} \binom{p^{e-1}}{i} (sp)^{i} = 1 + sp^{e} + s^2 \frac{p^{e-1}-1}{2} p^{e+1} + \cdots \equiv 1 \pmod{p^e}$이다.<br>
$(1+sp)^{p^{e-2}} = \sum_{i=0}^{p^{e-2}} \binom{p^{e-2}}{i} (sp)^{i} = 1 + sp^{e-1} + s^2 \frac{p^{e-2}-1}{2} p^e + \cdots \equiv 1 + sp^{e-1} \pmod{p^e}$이다. <br><br>
따라서 $p \nmid s$라면 $\ord_{p^e}(1+sp) = p^{e-1}$이다.<br><br>
$g$가 $(\ZnZ[p])^\times$의 원시근이라면, $g^{p-1} \equiv 1 \pmod{p}$이므로 $g^{p-1} = 1 + sp$ 꼴로 나타낼 수 있다. 만약 $p \mid s$라면, 
$$ \begin{aligned} 
\quad (g+p)^{p-1} & = \sum_{i=0}^{p-1} \binom{p-1}{i} g^{p-1-i} p^{i} = g^{p-1} + g^{p-2} p + g^{p-3}p^2 + \cdots \\
& = 1+sp + g^{p-2}p + g^{p-3}p^2 + \cdots = 1 + g^{p-2}p + \Big(\frac{s}{p}+g^{p-3}+\cdots\Big)p^2
\end{aligned}$$<br>
를 대신 사용하는 것으로 $p \nmid s$로 만들 수 있다. ($\because p \nmid g^{p-2}$) 따라서 이 경우에는 $g := g+p$로 생각하자. <br><br>
이제 $g^{(p-1)p^{e-2}} \equiv (g^{p-1})^{p^{e-2}} \equiv (1+sp)^{p^{e-2}} \equiv 1+sp^{e-1}\not\equiv 1$이므로 $\ord_{p^e} g \nmid (p-1)p^{e-2}$이다. 또한 $g^{\phi(p^e)} \equiv g^{(p-1)p^{e-1}} \equiv 1$이므로 $\ord_{p^e} g \mid (p-1)p^{e-1}$이다. $p$가 소수이므로 $\ord_{p^e} g = (p-1)p^{e-1}$이고, 따라서 $g$는 $(\ZnZ[p^e])^{\times}$의 원시근이 된다. 


- $p = 2, e = 2$의 경우 ($n = 4$)<br>
$3^0 = 1$, $3^1 = 3$이므로 $g = 3$이 원시근이 된다.

- $p = 2, e \geq 3$의 경우<br>
$(1+4)^{2^{e-2}} = \sum_{i=0}^{2^{e-2}} \binom{2^{e-2}}{i} (2^2)^i = 1 + 2^{e} + 2^{e+1} (2^{e-2}-1) + \cdots \equiv 1 \pmod{2^e}$이다.<br>
$(1+4)^{2^{e-3}} = \sum_{i=0}^{p^{e-3}} \binom{2^{e-3}}{i} (2^2)^i = 1 + 2^{e-1} + 2^{e} (2^{e-3}-1) + \cdots \equiv 1 + 2^{e-1} \pmod{2^e}$이다. <br>$\phi(2^e) = 2^{e-1}$이므로 $\ord_{2^e}(5) \mid 2^{e-1}$이고, 위 식에 의해 $\ord_{2^e}(5) = 2^{e-2}$라는 것을 알 수 있다. 따라서 $5$는 $(\ZnZ[2^e])^\times$의 원시근**이 아니다.** <br><br>
$a \equiv 1 \pmod{4}$에 대해 $a \equiv 5^k \pmod{2^{e-1}}$라고 하자. 따라서 $a \equiv 5^k + b2^{e-1} \pmod{2^e}$이 $$b \in \{0, 1\}$$에 대해 성립한다. 만약 $b = 0$이라면 $\ZnZ[2^e]$에서도 $a$를 $5^k$꼴로 나타낼 수 있다. 아니라면, $5^{2^{e-3}} \equiv 1+2^{e-1} \pmod {2^e}$이므로<br><span style="display: inline-block; margin-top: 3em"></span>
$$\qquad\begin{aligned} 5^{k + 2^{e-3}} & \equiv 5^k \cdot 5^{2^{e-3}} \equiv 5^k(1+2^{e-1}) \equiv 5^k + (1+4)^k(2^{e-1}) \\
& \equiv 5^k + (1+4m)(2^{e-1}) \equiv 5^k + 2^{e-1} + m \cdot 2^{e+1} \\
& \equiv 5^k + 2^{e-1} \equiv a \pmod{2^e}\end{aligned}$$<br><span style="display: inline-block; margin-bottom: 2em"></span>
가 성립한다. 또한 $e = 3$에 대해, $1 \equiv 5^0 \pmod{2^3}$ / $5 \equiv 5^1 \pmod{2^3}$이 성립한다. <br><br>
한편, $a \equiv 3 \pmod{4}$라면 $-a \equiv 1 \pmod{4}$이다. 결과적으로, $e \geq 3$와 $a \in (\ZnZ[2^e])^\times$에 대해 $a \equiv (-1)^t 5^u \pmod{2^e}$를 만족하는 정수 $$t \in \{0, 1\}, u \in \{0, \cdots, 2^{e-2}-1\}$$가 존재한다.

따라서 원시근이 존재하는 경우 $(\ZnZ[p^e])^\times \cong \ZnZ[\phi(p^e)]$이며, $p = 2, e \geq 3$인 경우는 $(\ZnZ[2^e])^\times \cong \ZnZ[2] \times \ZnZ[2^{e-2}]$이 된다.